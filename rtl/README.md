## Description
This directory contains the RTL verilog models of the systolic arrays, the equivalent verilated C++ designs and the Gemmini interface adapter library to simulate the Mesh unit. Instructions to port new Gemmini configurations are shown below.

### Structure
The structure of this directory is as follows:

1. Folder [designs](./designs): Contains verilog samples of the Gemmini Mesh unit. This must include, for each config:
    - Mesh.sv file: The top level Mesh module from Chipyard;
    - Tile.sv file: Contains PE units. Currently, all sample configs contain a single PE per tile;
    - PE_.sv: The PE unit. This orchestrates how inputs are stored, mapped to the MAC unit, and compute the outputs. This file is going to have a number attatched to the file name (e.g., PE_256.sv), depending on the configuration;
    - MacUnit.sv: the MAC unit.

2. Folder [verilated](./verilated): Contains the C++ verilated designs. After you run `./verilate.sh <config>`, a new folder is generated for each design;

3. The script [`extract_pointers.py`](extract_pointers.py): A parser script that reads the `Mesh.sv` input file and extracts every input/output and control register associated with each PE in the Mesh unit. This parser emmits C++ vector declarations, containing pointers to every PE signal, to the path `lib/Gemmini/headers/gemmini-pointers/<os or ws>/<CONFIG>.cc`;

3. Folder [lib/Gemmini](./lib/Gemmini): the main C++ interface adapters to simulate the Mesh unit (as described in the paper). This interface sets the inputs to the simulated Mesh unit and orchestrates the control signals to perform basic systolic operations: input preloading, input streaming through the PEs, and flushing the outputs from the PE accumulators (OS mode).

### Porting new configurations
Some Gemmini configuration examples are provided in [designs](./designs). These configurations are instantiated in [`pytorch/src/gemmini/gemmini_config.py`](../pytorch/src/gemmini/gemmini_config.py). For injection experiments, configs are selected through the `$gemmini_config_key` experiment variable (in your experiment scripts) to index the specific key. 

Adding new Gemmini configurations requires generating the verilog code with the [Chipyard](https://chipyard.readthedocs.io/en/latest/) framework. Follow the instructions they provide. After the hardware generation, use the design examples provided in the [designs](./designs) folder. Follow the same pattern as shown in the examples. 

To port a new configuration, let's say `Systamagotchi`, do:

1. Copy the Mesh-related verilog modules generated by Chipyard (Mesh.sv, Tile.sv, PE_256.sv, PE.sv, MacUnit.sv) to your design folder: `rtl/designs/Systamagotchi`;

2. Generate the C++ representation of the verilog design in `rtl/designs/verilated/Systamagotchi`. Run:
```
cd rtl
./verilate.sh Systamagotchi 
```

3. Extract the Mesh and PE pointers. The output C++ files (*.cc) will contain the extracted pointers to the PE signals. Note that you have to choose one of two folders: **os** or **ws**, according to the array execution mode of `Systamagotchi` (Output Stationary or Weight Stationary). Run:

```
python extract_pointers.py designs/Systamagotchi/Mesh.sv lib/Gemmini/headers/gemmini-pointers/<os or ws>/Systamagotchi.cc
```

4. Create a new config header file `rtl/lib/Gemmini/headers/configs/<os or ws/Systamagotchi.h`. Configure this header by including the path of the verilated design. Follow the pattern of the other examples in the folder: just copy and paste an existing config file, rename it to `Systamagotchi.h`. Open the file and replace the included paths with `Systamagotchi`. Define the DIM macro and data types fitting your design;

6. Port the new configuration in the file [`pytorch/src/gemmini/gemmini_config.py`](../pytorch/src/gemmini/gemmini_config.py): add the `Systamagotchi` config to the dictionary `CONFIG_PARAMS` and setup the config parameters properly;

7. Test the config: set the new config in [`pytorch/tests/test_gemmini.py`](../pytorch/tests/test_gemmini.py) with `CONFIG_KEY="Systamagotchi"`, then:
```
cd pytorch
python tests/test_gemmini.py
```